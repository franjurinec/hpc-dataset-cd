name: Execute Workflow on SLURM
on:
  push:
    tags:
    - '*'
jobs:
  execute:
    name: Execute on SLURM
    runs-on: ubuntu-latest
    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh/
          echo "$SSH_KEY" > ~/.ssh/slurm.key
          chmod 600 ~/.ssh/slurm.key
          cat >>~/.ssh/config <<END
          Host slurm
            HostName $SSH_HOST
            User $SSH_USER
            IdentityFile ~/.ssh/slurm.key
            StrictHostKeyChecking no
            ForwardAgent yes
            PasswordAuthentication no
          END
        env:
          SSH_USER: ${{ secrets.SLURM_USER }}
          SSH_KEY: ${{ secrets.SLURM_SSH_KEY }}
          SSH_HOST: ${{ secrets.SLURM_LOGIN_HOST }}
      - name: Configure Target Directory
        run: echo "TARGET_DIR=${{ secrets.SLURM_TMP }}/$(echo ${{ github.ref_name }} | iconv -t ascii//TRANSLIT | sed -E -e 's/[^[:alnum:]]+/-/g' -e 's/^-+|-+$//g' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
      - name: Download Source Code
        run: ssh slurm git clone --depth 1 --branch ${{ github.ref_name }} https://github.com/${{ github.repository }}.git $TARGET_DIR
      - name: Execute
        run: ssh slurm sbatch --wait $TARGET_DIR/slurm.sh
      - name: Print Results
        run: ssh slurm cat $TARGET_DIR/*.out
      - name: Cleanup
        run: ssh slurm rm -rf $TARGET_DIR